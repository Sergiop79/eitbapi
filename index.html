<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>EITB nahieran: askatu bideoak API honen bidez</title>

        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/fonts.css">
        <link rel="stylesheet" href="css/font-awesome.min.css">
        <link rel="stylesheet" href="css/theme/white.css">
        <link rel="stylesheet" href="css/custom.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/zenburn.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1>EITB nahieran: askatu bideoak API honen bidez</h1>
                    <p>
                        by Mikel Larreategi <br />
                        <a href="https://twitter.com/erralin">
                            <i class="fa fa-twitter"></i>
                        </a>
                        <a href="https://github.com/erral">
                            <i class="fa fa-github"></i>
                        </a>
                    </p>

                    <img data-src="img/europython-2016-logo-white-bg.png" />
                    <img data-src="img/codesyntax-logo.png" />
                </section>

                <section>
                    <img data-src="img/python-logo.png" /><br>
                    <img data-src="img/zope-logo.png" /><br>
                    <img data-src="img/plone-logo.png" /> <br>
                    <img data-src="img/django-logo-negative.png" /><br>
                    <aside class="notes">
                        Ni Mikel Larreategi naiz, ezagutzen ez nauzuenontzat
                        CodeSyntaxen egiten dut lan webguneak, intranetak eta
                        web aplikazioak egiten gehienbat.

                        Hasiera hasieratik python erabiliz horretarako.

                        Gehien Plone izeneko edukiak kudeatzeko sistema
                        erabiltzen dut, baina Django ere gero eta gehiago
                        egiten dut.

                        Baina egia esateko Pythonen dabilen edozer ikutzeko
                        gogoa eukitzen dugu
                    </aside>

                </section>

                <section>
                    <h1>EITB APIa? Zergatik? (I)</h1>
                    <p>
                        <ul>
                                <li>Zergatik ez?</li>
                                <li>Gurea ere bada, ezta?</li>
                                <li>XXI. mendean gaude jada...</li>
                        </ul>
                    </p>
                </section>

                <section>
                    <h1>Zergatik? (II)</h1>
                    <p>
                        <ul>
                            <li>Webgunea infumablea iruditzen zaidalako</li>
                            <li>Ez dudalako lortzen ganoraz ezer ikustea</li>
                            <li>Nabigatzailea kolgatzen didalako</li>
                            <li>Flash erabiltzen duelako eta askotan ez zaidalako kargatzeko</li>
                        </ul>
                    </p>
                </section>
                <section>
                    <img data-src="img/eitb-beltza.png" alt="" />
                    <aside class="notes">
                        Hau ikusteaz nazkatu egin zaielako
                    </aside>
                </section>

                <section>
                    Beno, badago beste arrazoi bat...
                </section>

                <section>
                    <h1>Raspberry & Kodi </h1>
                    <p>
                        <ul>
                            <li>Raspberry PI bat erosi nuen</li>
                        </ul>
                    </p>
                    <p>
                        <img data-src="img/Raspberry_Pi_Logo.png" alt="" />
                        <img data-src="img/thumbnail-light-300x300.png" alt="" />
                    </p>
                    <aside class="notes">
                        Badakizue, Raspberry bat erosi mila ideiarekin
                        eta azkenean kajoian gelditzen da...

                        Etxe aldaketa aprobatxatu nuen, berrian ezin nuelako
                        zuzenean ordenagailua telebistara lotu, Raspberrya
                        Media Center bihurtzeko
                    </aside>
                </section>

                <section>
                    <h1>Kodi, XBMC, ...</h1>

                    <h2>
                        <a href="http://blog.tvalacarta.info/plugin-xbmc/tvalacarta/descargar/">tvalacarta</a>
                    </h2>

                    <aside class="notes">
                        Eta Kodi, XBMC eta izen saltsa horretan aklaratu artean
                        pluginak deskargatu eta probatzen ibili nintzen tvalacarta
                        izeneko bat aurkitu nuen arte.

                        Interneten hortik zehar dauden EITB Nahieran antzeko zerbitzuak
                        zuzenean ikusteko aukera ematen zuen plugina.

                        Hau da, nik nahi dudanean, nik nahi dudan programa ikusi,
                        ordenagailua piztu eta sofatik eroso-eroso ikusteko
                    </aside>
                </section>

                <section>
                    <h1>EITB eta tvalacarta?</h1>
                    <p>
                        <ul>
                            <li>
                                Ba bai, tvalacartak bazeukan EITB ikusteko aukera, baina ez zebilen
                            </li>
                            <li>Webgune zaharrerako prestatuta zegoen</li>
                            <li>Screenscraping egiten zuen</li>
                        </ul>
                    </p>
                </section>

                <section>
                        <pre class="stretch"><code class="python" data-noescape>def mainlist(item):
    logger.info("[eitb.py] mainlist")
    itemlist=[]

    url = 'http://www.eitb.tv/es/'

    # Descarga la página
    data = scrapertools.cachePage(url)
    patron = "#CENSORED REGEX#"
    matches = re.compile(patron,re.DOTALL).findall(data)
    if DEBUG: scrapertools.printMatches(matches)

    for id,titulo,titulo2 in matches:
        scrapedtitle = titulo
        if titulo!=titulo2:
            scrapedtitle = scrapedtitle + " - " + titulo2
        scrapedurl = "http://www.eitb.tv/es/get/playlist/"+id
        scrapedthumbnail = ""
        scrapedplot = ""
        if (DEBUG): logger.info("title=["+scrapedtitle+"], url=["+scrapedurl+"], thumbnail=["+scrapedthumbnail+"]")

        itemlist.append( Item(channel=CHANNELNAME, title=scrapedtitle , action="episodios" , url=scrapedurl, thumbnail=scrapedthumbnail, plot=scrapedplot , folder=True) )

    return itemlist

</code>
</pre>

                    <a href="https://github.com/erral/tvalacarta/blob/3ed23b470130d91793b4e07e9ccfcfe6ac19f760/python/main-classic/channels/eitb.py">Programen zerrenda lortzeko kodea</a>

                    <aside class="notes">
                        Hori egiten du programa zerrenda lortzeko
                        HTMLa irakurri eta handik programen helbideak atera
                        Gainera kodea nahiko zikina da, javascript bidez aktibatzen
                        diren loturekin.

                    </aside>
                </section>

                <section>
                    <pre class="stretch"><code class="python" data-noescape>
def get_rtmp(key, content_id, url, exp_id):
    conn = httplib.HTTPConnection("c.brightcove.com")
    envelope = build_amf_request(key, content_id, url, exp_id)
    logger.info("REQUEST="+str(envelope))
    encoded = remoting.encode(envelope)
    logger.info("encoded="+str(encoded))
    stringenvelope=str(encoded.read())
    logger.info("stringenvelope="+stringenvelope)
    conn.request("POST", "/services/messagebroker/amf?playerKey="+keytringenvelope,{'content-type': 'application/x-amf'})
    response = conn.getresponse().read()
    logger.info("RESPONSE="+str(response))
    response = remoting.decode(response).bodies[0][1].body
    logger.info("RESPONSE="+str(response))
    return response
                        </code>
                    </pre>
                    <a href="https://github.com/erral/tvalacarta/blob/3ed23b470130d91793b4e07e9ccfcfe6ac19f760/python/main-classic/servers/eitb.py">Bideo baten helbidea lortzeko "marabilak"</a>
                    <aside class="notes">
                        Eta programa jakin baten bideo baten helbidea lortzea
                        ere, tela marinera
                    </aside>
                </section>

                <section>
                    <h2>2016 urtean horrela ibili behar izatea ere TB publiko batekin...</h2>
                    <img class="stretch" data-src="img/sheldon-bag.gif" alt="" />
                </section>

                <section>
                    <h1>Ba nik egingo dut</h1>
                    <img class="fragment" data-src="img/ktpng.gif" />

                    <aside class="notes">
                        Total, screenscrapping egin behar bada, *neuk egingo dut*
                        pentsatu nuen eta han ireki nuen Firebug eta network pestaña
                        nabigatzaileak egiten zituen eskaerak ikusteko eta...
                    </aside>
                </section>

                <section>
                    <img data-src="img/JS-2016-07-08 10-36-29.png" />
                </section>

                <section>
                    <img data-src="img/XHR-2016-07-08 10-32-08.png" alt="" />

                    <aside class="notes">
                        Nabigatzailea 2 edo 3 aldiz kolgatu ostean milaka eskaera ikusi nituen.

                        Bideo bat eskatzen diozunean, sesio bat irekitzen du hirugarren
                        zerbitzari baten bideoa eskatu duzula ikusteko eta cookie bat
                        pasatzen dio eta horrekin bideoa erreproduzitzen hasten da.
                    </aside>
                </section>

                <section>
                    <img data-src="img/giphy.gif" class="stretch" alt="" />
                    <aside class="notes">
                        Hori ikusita, utzi egin nuen...
                    </aside>
                </section>

                <section>
                    <p>Utzi baina....</p>
                    <p class="fragment"><a href="https://pypi.python.org/pypi/youtube_dl">youtube-dl</a> ezagutu nuen arte</p>
                </section>

                <section>
                    <h1>youtube-dl</h1>
                    <p>
                        <ul>
                            <li>Youtubetik bideoak deskargatzeko aplikazioa</li>
                            <li>Python pakete bat da</li>
                            <li>Python paketeetatik erabili daiteke</li>
                            <li class="fragment">
                                <strong>Eta ez da youtuberako bakarrik, EITBrekin funtzionatzen du</strong>
                            </li>
                        </ul>
                    </p>
                </section>

                <section>
                    <img class="stretch" data-src="img/giphyjoker.gif" alt="" />
                </section>

                <section>
                    <h2>Kodea youtube-dl-rekin</h2>
                    <pre class="stretch"><code class="python">
def get_video_url( page_url , premium = False , user="" , password="", video_password="", page_data="" ):
    logger.info("[eitb.py] get_video_url(page_url='%s')" % page_url)

    ydl = youtube_dl.YoutubeDL({'outtmpl': u'%(id)s%(ext)s'})
    result = ydl.extract_info(page_url, download=False)
    video_urls = []
    if 'formats' in result:
        for entry in result['formats']:
            if 'http' in entry['format']:
                video_urls.append([safe_unicode(entry['format']).encode('utf-8'), safe_unicode(entry['url']).encode('utf-8')])
                logger.info('Append: {}'.format(entry['url']))

    return video_urls
                    </code></pre>
                    <aside class="notes">
                        Hori eginda Yotube-dl enkargatzen da "lan zikina egiteaz"
                        Gu, telebista aurrean jarri eta ikusi bakarrik
                    </aside>
                </section>
                <section>
                    <img class="stretch" src="img/homerpopcorn.gif" alt="" />
                </section>
                <section>
                    <h1>eta API bat egiten badut?</h1>
                    <img class="stretch" data-src="img/oprah-thinking.gif" />
                    <aside class="notes">
                        Ze klaro, EITBk ez du egingo...
                    </aside>
                </section>
                <section>
                    <h1>EITB APIa</h1>
                    <p>
                        <ul>
                            <li>Pyramid-en eginda</li>
                            <li>Framework arin-arina</li>
                            <li>Zuk aukeratu guztia (DB, template, ...)</li>
                        </ul>
                    </p>
                    <p>
                        <a href="http://www.pylonsproject.org/">
                            <img data-src="img/pyramid-medium.png" alt="" />
                        </a>
                    </p>
                    <aside class="notes">
                        Pyramid erabiltzea erabaki nuen: framework arin-arina da,
                        ez du erabakirik hartzen ezeren inguruan: zure esku dago
                        nola funtzionatuko duen: url-ak ruta bezala edo traversal bezala
                        (django vs. zope), datubasea (sql, ZODB, no-sql, datu-baserik ez, ...)
                        plantillak (zpt, django, jinja, stringak...); gaineko maila ematen dizu
                        guztia pegatzeko pegamentua.
                    </aside>
                </section>

                <section>
                    <h1>APIa pyramid-en</h1>
                    <p>
                        <ul>
                            <li>Misteriorik ez</li>
                            <li>3 URL: programa guztiak, programa baten saioak, eta saioa</li>
                            <li>Plone-ren API lanean inspiratuta</li>
                        </ul>
                    </p>
                    <aside class="notes">
                        Bai, Plone berriz :)
                        Gutxi gora-behera sasoi berean Ploneren REST APIa prestatzen zebiltzan
                        eta horretarako egindako lanean inspiratzen saiatu nintzen, nola edo hala APIa
                        nabegablea izateko, hau da, bertan agertzeko programa, saio eta guztien helbideak,
                        era erraz baten erabili ahal izateko.

                    </aside>
                </section>

                <section>
                    <h1>Esan eta egin</h1>
                    <a href="https://still-castle-99749.herokuapp.com">
                        Nabigatu APIan
                    </a>
                </section>

                <section>
                    <pre class="stretch"><code class="python">
@view_config(route_name='programs', renderer='prettyjson')
def programs(request):
    """get all information about all the programs.
    How: scrap the website and look for the javascript links.
    """
    data = requests.get(EITB_FRONT_PAGE_URL)
    matches = re.compile(EITB_EPISODE_LIST_REGEX, re.DOTALL).findall(data.text)

    result = {
        '@context': 'http://www.w3.org/ns/hydra/context.jsonld',
        '@id': request.route_url('programs'),
        '@type': 'TV',
        'parent': {},
    }

    results = []

    for id, title1, title2 in matches:
        scrapedtitle = title1
        if title1 != title2:
            scrapedtitle = scrapedtitle + " - " + title2

        results.append({
            '@id': request.route_url('playlist', playlist_id=id),
            '@type': 'Playlist',
            'title': scrapedtitle,
            'description': '',
        })

    result['member'] = results

    return result
                    </code></pre>
                </section>

                <section>
                    <pre class="stretch"><code class="python">
@view_config(route_name='playlist', renderer='prettyjson')
def playlist(request):
    """ get all the information about the given program.
        How: get the information from a pseudo-api
    """
    playlist_id = request.matchdict['playlist_id']


    result = {
        '@context': 'http://www.w3.org/ns/hydra/context.jsonld',
        '@id': request.route_url('playlist', playlist_id=playlist_id),
        '@type': 'Playlist',
        'parent': request.route_url('programs'),
    }

    playlist_url = EITB_PLAYLIST_BASE_URL.format(playlist_id)
    data = requests.get(playlist_url)
    playlist_data = data.json()
    web_medias = playlist_data.get('web_media')
    del playlist_data['web_media']

    playlist_data['member'] = []
    for web_media in web_medias:
        item = {
            '@id': create_internal_video_url(
                playlist_data.get('name_playlist'),
                playlist_data.get('id_web_playlist'),
                web_media.get('NAME_ES'),
                web_media.get('ID_WEB_MEDIA'),
                request=request,
            ),
            '@type': 'Episode',
            'title': web_media.get('NAME_ES'),
            'description': web_media.get('SHORT_DESC_ES', ''),
        }
        playlist_data['member'].append(item)
    del playlist_data['id']

    result.update(playlist_data)
    return result
                    </code></pre>
                </section>

                <section>
                    <pre class="stretch"><code class="python">
@view_config(route_name='episode', renderer='prettyjson')
def episode(request):
    """ Get all the information and the video links from a given episode.
        How: use youtube-dl to get the information
    """
    episode_url = request.matchdict['episode_url']

    url = EITB_VIDEO_BASE_URL + episode_url

    playlist_title, playlist_id, video_title, video_id = episode_url.split('/')
    result = {
        '@context': 'http://www.w3.org/ns/hydra/context.jsonld',
        '@id': request.route_url('episode', episode_url=episode_url),
        '@type': 'Episode',
        'parent': request.route_url('playlist', playlist_id=playlist_id),
    }

    ydl = youtube_dl.YoutubeDL({'outtmpl': '%(id)s%(ext)s'})
    video_data = ydl.extract_info(url, download=False)

    result.update(video_data)

    return result
                    </code></pre>
                </section>

<section>
    <pre class="stretch"><code class="python">
def clean_title(title):
    """slugify the titles using the method that EITB uses in
       the website:
       - url: http://www.eitb.tv/resources/js/comun/comun.js
       - method: string2url
    """
    translation_map = {
        'À': 'A', 'Á': 'A', 'Â': 'A', 'Ã': 'A', 'Ä': 'A', 'Å': 'A', 'Æ': 'E',
        'È': 'E', 'É': 'E', 'Ê': 'E', 'Ë': 'E',
        'Ì': 'I', 'Í': 'I', 'Î': 'I', 'Ï': 'I',
        'Ò': 'O', 'Ó': 'O', 'Ô': 'O', 'Ö': 'O',
        'Ù': 'U', 'Ú': 'U', 'Û': 'U', 'Ü': 'U',
        'Ñ': 'N', '?': '', '¿': '', '!': '',
        '¡': '', ': ': '', '_': '-', 'º': '',
        'ª': 'a', ',': '', '.': '', '(': '',
        ')': '', '@': '', ' ': '-', '&': ''
    }

    val = title.upper()
    for k, v in translation_map.items():
        val = val.replace(k, v)
    return val.lower()

    </code></pre>
    <aside class="notes">
        EITBren webgunetik JavaScript kodea "lapurtu" behar izan nuen,
        URLak era egokian sortzeko konbertsioak JavaScript bidez egiten
        dituztelako programen izenburuetatik abiatuz eta karaktere bereziak
        kenduz
    </aside>
</section>
                <section>
                    <h1>eta honekin zer?</h1>
                    <p>
                        <ul>
                            <li>Egin nahi duzuna</li>
                            <li>EITBk ez badu egiten, besteok egingo dugu</li>
                            <li>Telebista ikusteko beste modu batzuk daude orain</li>
                            <li>Kodi bat da, baina beste mila daude</li>
                            <li>Eman sarrera bideotekara era garbi baten</li>
                        </ul>
                    </p>
                </section>
                <section>
                    <h2>ingurukoek badute APIa</h2>
                    <p>
                        Eta garatzaileok gauzak egiteko aukera dugu
                        <ul>
                            <li>
                                <a href="https://es.wikibooks.org/wiki/API_Rtve">RTVE</a>

                            </li>
                            <li><a href="https://developer.bbc.co.uk/">BBC</a></li>
                            <li><a href="https://projects.pbs.org/confluence/display/coveapi/COVE+API+Developer+Documentation">PBS</a></li>
                            <li><a href="NPR">http://www.npr.org/api/index</a></li>
                        </ul>
                    </p>
                    <aside class="notes">
                        Beste batzuk badute, edo APIak daude, edo RSSak edo zerbait
                        era programatikoan programa eta bideoetara sarrera izateko
                        EITBri ere esan genion jada tvalacarta-rena egin genuenean
                        eta erantzun zuzen horietako bat eman ziguten "bai, aztertu
                        behar dugu, negozio eredua, eta publizitatea? eta klikak kontatu
                        ditzakegu, eta...?"
                        Interes handirik ez...
                    </aside>

                </section>
                <section>
                    <p>
                        Jendeak eskatzen badu egin beharko dute.
                        Denok joan beharko gara EITBra eskatzera
                    </p>
                    <img class="stretch" data-src="img/sheldon-penny-penny-penny.gif" alt="" />
                    <aside class="notes">
                        API batek irismena emango dio EITBri, bere bideoak ikusteko
                        Chromecast-ak, Kodi, ... telebista ikusteko moduak aldatu
                        egin dira... guztia kontuan izan behar da, ez publizitatea
                        eta klikak bakarrik.
                    </aside>
                </section>
                <section>
                    <h1>Galderarik?</h1>
                    <img class="stretch" data-src="img/life-of-brian-stoning.jpg" alt="" />
                </section>
                <section>
                    <h1>Eta ez ahaztu...</h1>
                    <img data-src="img/PythonUnicode.png" />

                </section>
            </div>
        </div>

        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.js"></script>

        <script>
            // More info https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                history: true,

                // More info https://github.com/hakimel/reveal.js#dependencies
                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
                ]
            });
        </script>
    </body>
</html>
